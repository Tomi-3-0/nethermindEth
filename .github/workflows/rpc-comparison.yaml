name: '[JSON-RPC] Compare Nethermind between clients and versions'

on:
  push:
    branches:
      - 'rpc-comparison-testing'
  workflow_dispatch:
    inputs:
      allowed_ips:
        type: string
        description: "A comma-separated list of ips allowed to connect to the node"
        default: ""
        required: false

jobs:
  get_ip:
    runs-on: ubuntu-latest
    outputs:
      ip: ${{ steps.ip.outputs.ipv4 }}
    steps:
      - name: Get runner ip addresses
        id: ip
        uses: haythem/public-ip@v1.2
      - run: echo "${{ steps.ip.outputs.ipv4 }}"

  create_node: 
    name: Create node from current branch
    uses: ./.github/workflows/run-a-single-node-from-branch.yml
    needs: get_ip
    secrets: inherit
    with:
      allowed_ips: ${{ needs.get_ip.outputs.ip }},${{ inputs.allowed_ips }}
  
  extract_rpc_url:
    name: Extract RPC url from artifacts generated by create_node 
    runs-on: ubuntu-latest
    needs: create_node
    outputs:
      rpc_url: ${{ steps.extract_rpc_url.outputs.rpc_url }}
    steps:
      - name: Download artifact
        id: download-artifact
        uses: dawidd6/action-download-artifact@v2
        with:
          github_token: ${{ secrets.REPOSITORY_DISPATCH_TOKEN }}
          run_id: ${{ needs.create_node.outputs.run_id }}
          name: "${{ github.actor }}-${{ needs.create_node.outputs.base_tag }}-smoketests"
          repo: NethermindEth/post-merge-smoke-tests

      - run: echo "${{ github.actor }}-${{ needs.create_node.outputs.base_tag }}-smoketests"
      - run: echo "${{ github.actor }}-${{ needs.create_node.outputs.rpc_url }}-smoketests"

      - name: Get RPC url to the newly created node
        id: extract_rpc_url
        run: echo "rpc_url=$(cat ./terraform.tfstate | jq '.outputs.nodes_data.value[0].rpc_url')" >> $GITHUB_OUTPUT

  compare:
    name: Compare JSON-RPC responses between clients and versions
    runs-on: ubuntu-latest
    needs: extract_rpc_url
    strategy:
      matrix:
        rpc_to_compare: [INFURA_ENDPOINT, NETHERMIND_ARCHIVE_ENDPOINT]
    steps:
    - name: Install flood
      run: pip install git+https://github.com/piwonskp/flood.git
  
    - name: Test equality of responses
      run: flood all nethermind_current=${{ needs.extract_rpc_url.outputs.rpc_url }} ${{ matrix.rpc_to_compare }}=${{ secrets[matrix.rpc_to_compare] }} --equality
    